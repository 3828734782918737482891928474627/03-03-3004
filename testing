local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Fsys = require(ReplicatedStorage:WaitForChild("Fsys"))
local UIManager = Fsys.load("UIManager")

local TradeApp = UIManager.apps.TradeApp
if not TradeApp then
    warn("[0KSAM Trade] TradeApp not found. Abort.")
    return
end

-- Store original functions for bypass
local originalAccept     = TradeApp._on_accept_pressed
local originalConfirm    = TradeApp._on_confirm_pressed
local originalOverwrite  = TradeApp._overwrite_local_trade_state
local originalRemove     = TradeApp._remove_item_from_my_offer or function() end

-- State variables
local fakeActive               = false
local fakeTradeId              = nil
local currentTargetName        = "The0ksam"
local currentTargetDisplayName = "The0ksam"
local currentTargetId          = 0
local acceptDelay              = 5
local confirmDelay             = 5
local spectatorLoopRunning     = false
local allowOverwrite           = false
local tradeUnlockAt = 0
local LOCK_DURATION = 5

local STATIC_PLAYER_NAMES = {
    "The0ksam",
    "Roblox",
    "builderman",
    "cammyxboba",
    "themeganplays",
}

-- Pet system
local PET_KINDS = {
    "bat_dragon",
    "shadow_dragon",
    "frost_dragon",
    "giraffe",
    "parrot",
    "crow",
    "arctic_reindeer",
    "albino_monkey",
}

local RARITY_PROPS = {
    { mega_neon = true,  neon = false, flyable = true, rideable = true }, -- MFR
    { mega_neon = false, neon = true,  flyable = true, rideable = true }, -- NFR
    { mega_neon = false, neon = false, flyable = true, rideable = true }, -- FR
    { mega_neon = false, neon = false, flyable = true, rideable = false }, -- F only
}

-- Chat presets from original script
local CHAT_PRESETS = {
    "OMGGG TYSMM",
    "wait let me check values",
    "let me check elve",
    "im over",
    "can you add?",
    "can you spin this??",
    "yes",
    "no",
    "offer for this?",
    "guys they are trusted omg.",
    "Loading random pet for restock..",
    "Finished restocking.",
}

-- Create square, thin GUI with circular RGB borders
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "0KSAMTradeGUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 280, 0, 280) -- Square dimensions
mainFrame.Position = UDim2.new(0.5, -140, 0.5, -140)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 20, 30) -- Dark base
mainFrame.BorderSizePixel = 0
mainFrame.Visible = true
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

-- Circular RGB Border Effect
local function createCircularRGBBorder()
    local borderThickness = 3
    
    -- Create a circular stroke using UIStroke with gradient
    local rgbStroke = Instance.new("UIStroke")
    rgbStroke.Name = "RGBStroke"
    rgbStroke.Thickness = borderThickness
    rgbStroke.Color = Color3.fromRGB(255, 100, 200)
    rgbStroke.Parent = mainFrame
    
    -- Animate the RGB effect
    local colorTime = 0
    RunService.RenderStepped:Connect(function(deltaTime)
        colorTime = (colorTime + deltaTime * 3) % 1
        
        -- Circular color rotation
        local r = 0.8 + 0.2 * math.sin(colorTime * 2 * math.pi)
        local g = 0.3 + 0.3 * math.sin(colorTime * 2 * math.pi + 2)
        local b = 0.7 + 0.3 * math.cos(colorTime * 2 * math.pi)
        
        rgbStroke.Color = Color3.fromRGB(255 * r, 100 * g, 200 * b)
    end)
    
    return rgbStroke
end

local rgbBorder = createCircularRGBBorder()

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 20) -- Very circular corners
mainCorner.Parent = mainFrame

-- Title bar with RGB effect
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 25, 40)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleBarCorner = Instance.new("UICorner")
titleBarCorner.CornerRadius = UDim.new(0, 20, 0, 0)
titleBarCorner.Parent = titleBar

local title = Instance.new("TextLabel")
title.Size = UDim2.new(0.8, 0, 1, 0)
title.Position = UDim2.new(0.1, 0, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 12
title.TextColor3 = Color3.fromRGB(255, 180, 230)
title.Text = "Fake Trade"
title.Parent = titleBar

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(0.8, 0, 0, 14)
subtitle.Position = UDim2.new(0.1, 0, 1, -14)
subtitle.BackgroundTransparency = 1
subtitle.Font = Enum.Font.Gotham
subtitle.TextSize = 9
subtitle.TextColor3 = Color3.fromRGB(180, 140, 200)
subtitle.Text = "click what to make this"
subtitle.Parent = titleBar

-- Close button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 20, 0, 20)
closeButton.Position = UDim2.new(1, -25, 0, 5)
closeButton.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
closeButton.BorderSizePixel = 0
closeButton.Font = Enum.Font.GothamBold
closeButton.TextSize = 10
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.Text = "X"
closeButton.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 10)
closeCorner.Parent = closeButton

-- Tab buttons (thin and square)
local tabContainer = Instance.new("Frame")
tabContainer.Size = UDim2.new(1, -20, 0, 20)
tabContainer.Position = UDim2.new(0, 10, 0, 35)
tabContainer.BackgroundTransparency = 1
tabContainer.Parent = mainFrame

local mainTab = Instance.new("TextButton")
mainTab.Size = UDim2.new(0.45, 0, 1, 0)
mainTab.Position = UDim2.new(0, 0, 0, 0)
mainTab.BackgroundColor3 = Color3.fromRGB(255, 120, 200)
mainTab.BorderSizePixel = 0
mainTab.Font = Enum.Font.Gotham
mainTab.TextSize = 10
mainTab.TextColor3 = Color3.new(1, 1, 1)
mainTab.Text = "main"
mainTab.Parent = tabContainer

local mainTabCorner = Instance.new("UICorner")
mainTabCorner.CornerRadius = UDim.new(0, 8)
mainTabCorner.Parent = mainTab

local chatTab = Instance.new("TextButton")
chatTab.Size = UDim2.new(0.45, 0, 1, 0)
chatTab.Position = UDim2.new(0.55, 0, 0, 0)
chatTab.BackgroundColor3 = Color3.fromRGB(60, 40, 70)
chatTab.BorderSizePixel = 0
chatTab.Font = Enum.Font.Gotham
chatTab.TextSize = 10
chatTab.TextColor3 = Color3.fromRGB(220, 180, 220)
chatTab.Text = "chat"
chatTab.Parent = tabContainer

local chatTabCorner = Instance.new("UICorner")
chatTabCorner.CornerRadius = UDim.new(0, 8)
chatTabCorner.Parent = chatTab

-- Main content frame
local mainContent = Instance.new("Frame")
mainContent.Name = "MainContent"
mainContent.Size = UDim2.new(1, -20, 1, -70)
mainContent.Position = UDim2.new(0, 10, 0, 60)
mainContent.BackgroundTransparency = 1
mainContent.Parent = mainFrame

-- Chat content frame (hidden by default)
local chatContent = Instance.new("Frame")
chatContent.Name = "ChatContent"
chatContent.Size = UDim2.new(1, -20, 1, -70)
chatContent.Position = UDim2.new(0, 10, 0, 60)
chatContent.BackgroundTransparency = 1
chatContent.Visible = false
chatContent.Parent = mainFrame

-- Start Trade Button
local startButton = Instance.new("TextButton")
startButton.Size = UDim2.new(1, 0, 0, 24)
startButton.Position = UDim2.new(0, 0, 0, 0)
startButton.BackgroundColor3 = Color3.fromRGB(255, 120, 200)
startButton.BorderSizePixel = 0
startButton.Font = Enum.Font.GothamBold
startButton.TextSize = 11
startButton.TextColor3 = Color3.new(1, 1, 1)
startButton.Text = "start visual trade"
startButton.Parent = mainContent

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 8)
startCorner.Parent = startButton

-- Max spectators
local specLabel = Instance.new("TextLabel")
specLabel.Size = UDim2.new(1, 0, 0, 16)
specLabel.Position = UDim2.new(0, 0, 0, 30)
specLabel.BackgroundTransparency = 1
specLabel.Font = Enum.Font.Gotham
specLabel.TextSize = 10
specLabel.TextColor3 = Color3.fromRGB(200, 160, 220)
specLabel.Text = "max spectators"
specLabel.TextXAlignment = Enum.TextXAlignment.Left
specLabel.Parent = mainContent

local specButtonsFrame = Instance.new("Frame")
specButtonsFrame.Size = UDim2.new(1, 0, 0, 20)
specButtonsFrame.Position = UDim2.new(0, 0, 0, 46)
specButtonsFrame.BackgroundTransparency = 1
specButtonsFrame.Parent = mainContent

local specButtons = {}
for i = 2, 5 do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.22, -4, 1, 0)
    btn.Position = UDim2.new(0.22 * (i-2), 0, 0, 0)
    btn.BackgroundColor3 = i == 4 and Color3.fromRGB(255, 120, 200) or Color3.fromRGB(60, 40, 70)
    btn.BorderSizePixel = 0
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 11
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Text = tostring(i)
    btn.Parent = specButtonsFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = btn
    
    specButtons[i] = btn
end

-- Action buttons
local addPetButton = Instance.new("TextButton")
addPetButton.Size = UDim2.new(1, 0, 0, 20)
addPetButton.Position = UDim2.new(0, 0, 0, 72)
addPetButton.BackgroundColor3 = Color3.fromRGB(255, 150, 100)
addPetButton.BorderSizePixel = 0
addPetButton.Font = Enum.Font.GothamBold
addPetButton.TextSize = 10
addPetButton.TextColor3 = Color3.new(1, 1, 1)
addPetButton.Text = "add high tier pet"
addPetButton.Parent = mainContent

local addPetCorner = Instance.new("UICorner")
addPetCorner.CornerRadius = UDim.new(0, 6)
addPetCorner.Parent = addPetButton

local removePetButton = Instance.new("TextButton")
removePetButton.Size = UDim2.new(1, 0, 0, 20)
removePetButton.Position = UDim2.new(0, 0, 0, 96)
removePetButton.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
removePetButton.BorderSizePixel = 0
removePetButton.Font = Enum.Font.GothamBold
removePetButton.TextSize = 10
removePetButton.TextColor3 = Color3.new(1, 1, 1)
removePetButton.Text = "remove last pet"
removePetButton.Parent = mainContent

local removePetCorner = Instance.new("UICorner")
removePetCorner.CornerRadius = UDim.new(0, 6)
removePetCorner.Parent = removePetButton

local acceptButton = Instance.new("TextButton")
acceptButton.Size = UDim2.new(1, 0, 0, 20)
acceptButton.Position = UDim2.new(0, 0, 0, 120)
acceptButton.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
acceptButton.BorderSizePixel = 0
acceptButton.Font = Enum.Font.GothamBold
acceptButton.TextSize = 10
acceptButton.TextColor3 = Color3.new(1, 1, 1)
acceptButton.Text = "make partner accept"
acceptButton.Parent = mainContent

local acceptCorner = Instance.new("UICorner")
acceptCorner.CornerRadius = UDim.new(0, 6)
acceptCorner.Parent = acceptButton

-- Partner section
local partnerSection = Instance.new("Frame")
partnerSection.Size = UDim2.new(1, 0, 0, 60)
partnerSection.Position = UDim2.new(0, 0, 0, 146)
partnerSection.BackgroundColor3 = Color3.fromRGB(40, 30, 50)
partnerSection.BorderSizePixel = 0
partnerSection.Parent = mainContent

local partnerCorner = Instance.new("UICorner")
partnerCorner.CornerRadius = UDim.new(0, 8)
partnerCorner.Parent = partnerSection

local partnerTitle = Instance.new("TextLabel")
partnerTitle.Size = UDim2.new(1, -10, 0, 16)
partnerTitle.Position = UDim2.new(0, 5, 0, 5)
partnerTitle.BackgroundTransparency = 1
partnerTitle.Font = Enum.Font.GothamBold
partnerTitle.TextSize = 10
partnerTitle.TextColor3 = Color3.fromRGB(255, 180, 230)
partnerTitle.Text = "trade partner"
partnerTitle.TextXAlignment = Enum.TextXAlignment.Left
partnerTitle.Parent = partnerSection

local partnerNameBox = Instance.new("TextBox")
partnerNameBox.Size = UDim2.new(1, -10, 0, 20)
partnerNameBox.Position = UDim2.new(0, 5, 0, 22)
partnerNameBox.BackgroundColor3 = Color3.fromRGB(30, 20, 35)
partnerNameBox.BorderSizePixel = 0
partnerNameBox.Font = Enum.Font.Gotham
partnerNameBox.TextSize = 10
partnerNameBox.TextColor3 = Color3.fromRGB(255, 200, 240)
partnerNameBox.PlaceholderText = "type username + press Enter"
partnerNameBox.PlaceholderColor3 = Color3.fromRGB(150, 100, 150)
partnerNameBox.Text = "The0ksam"
partnerNameBox.Parent = partnerSection

local nameBoxCorner = Instance.new("UICorner")
nameBoxCorner.CornerRadius = UDim.new(0, 6)
nameBoxCorner.Parent = partnerNameBox

-- Chat content
local chatScroll = Instance.new("ScrollingFrame")
chatScroll.Size = UDim2.new(1, 0, 1, 0)
chatScroll.Position = UDim2.new(0, 0, 0, 0)
chatScroll.BackgroundTransparency = 1
chatScroll.ScrollBarThickness = 3
chatScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
chatScroll.Parent = chatContent

local chatLayout = Instance.new("UIListLayout")
chatLayout.Padding = UDim.new(0, 5)
chatLayout.SortOrder = Enum.SortOrder.LayoutOrder
chatLayout.Parent = chatScroll

-- Add chat buttons
for i, msg in ipairs(CHAT_PRESETS) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 24)
    btn.BackgroundColor3 = Color3.fromRGB(60, 40, 70)
    btn.BorderSizePixel = 0
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 10
    btn.TextColor3 = Color3.fromRGB(255, 200, 240)
    btn.Text = msg
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.LayoutOrder = i
    btn.Parent = chatScroll
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = btn
    
    btn.MouseButton1Click:Connect(function()
        if fakeActive then
            local s = getLocalState()
            if s and s.trade_id == fakeTradeId then
                if TradeApp._render_message_in_trade_chat then
                    TradeApp:_render_message_in_trade_chat(
                        {
                            Name = currentTargetDisplayName,
                            UserId = currentTargetId,
                            DisplayName = currentTargetDisplayName
                        },
                        msg,
                        false,
                        false
                    )
                end
                statusLabel.Text = "Chat sent: " .. msg
            else
                statusLabel.Text = "No active trade"
            end
        end
    end)
end

chatScroll.CanvasSize = UDim2.new(0, 0, 0, #CHAT_PRESETS * 29)

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 14)
statusLabel.Position = UDim2.new(0, 10, 1, -18)
statusLabel.BackgroundTransparency = 1
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 9
statusLabel.TextColor3 = Color3.fromRGB(255, 180, 230)
statusLabel.Text = "Status: Ready"
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

-- API Functions
local function getLocalState()
    if TradeApp and TradeApp._get_local_trade_state then
        return TradeApp:_get_local_trade_state()
    end
    return nil
end

local function formatPetName(kind)
    return kind:gsub("_", " "):gsub("(%a)([%w_']*)", function(a,b)
        return a:upper() .. b:lower()
    end)
end

local function tagForProps(props)
    if props and props.mega_neon then return "MFR" end
    if props and props.neon then return "NFR" end
    if props and props.flyable and props.rideable then return "FR" end
    if props and props.flyable then return "F" end
    if props and props.rideable then return "R" end
    return ""
end

local function startSpectatorLoop()
    if spectatorLoopRunning then return end
    spectatorLoopRunning = true
    
    task.spawn(function()
        while spectatorLoopRunning and fakeActive do
            task.wait(math.random(7, 13))
            if not fakeActive then break end
            local s = getLocalState()
            if s and s.trade_id == fakeTradeId then
                allowOverwrite = true
                s.subscriber_count = math.random(0, 10)
                TradeApp:_overwrite_local_trade_state(s)
                allowOverwrite = false
                if TradeApp.refresh_all then
                    TradeApp:refresh_all()
                end
            end
        end
        spectatorLoopRunning = false
    end)
end

local function stopSpectatorLoop()
    spectatorLoopRunning = false
end

local function restoreHooks()
    TradeApp._on_accept_pressed           = originalAccept
    TradeApp._on_confirm_pressed          = originalConfirm
    TradeApp._overwrite_local_trade_state = originalOverwrite
    TradeApp._remove_item_from_my_offer   = originalRemove
end

-- BYPASS: Fake trade hooks
local function enableFakeTradeHooks()
    fakeActive = true
    
    TradeApp._overwrite_local_trade_state = function(self, trade, ...)
        if trade == nil and fakeActive and not allowOverwrite then
            fakeActive = false
            fakeTradeId = nil
            stopSpectatorLoop()
            restoreHooks()
            return originalOverwrite(self, trade, ...)
        end

        if not fakeActive or allowOverwrite then
            return originalOverwrite(self, trade, ...)
        end

        if trade == nil then
            fakeActive = false
            fakeTradeId = nil
            stopSpectatorLoop()
            restoreHooks()
            return originalOverwrite(self, trade, ...)
        end

        if trade and trade.trade_id and trade.trade_id ~= fakeTradeId then
            return
        end

        return originalOverwrite(self, trade, ...)
    end

    TradeApp._on_accept_pressed = function(self, ...)
        local s = getLocalState()
        if not fakeActive or not s or s.trade_id ~= fakeTradeId then
            return originalAccept(self, ...)
        end

        statusLabel.Text = "You clicked Accept"

        s.sender_offer.negotiated   = true
        s.sender_offer.confirmed    = false
        s.sender_offer.player_name  = LocalPlayer.Name

        allowOverwrite = true
        TradeApp:_overwrite_local_trade_state(s)
        allowOverwrite = false
        if TradeApp.refresh_all then
            TradeApp:refresh_all()
        end

        statusLabel.Text = "Auto-accepting partner..."
        task.delay(acceptDelay, function()
            local s2 = getLocalState()
            if not fakeActive or not s2 or s2.trade_id ~= fakeTradeId then return end

            s2.recipient_offer.negotiated  = true
            s2.recipient_offer.confirmed   = false
            s2.recipient_offer.player_name = currentTargetDisplayName
            
            if s2.recipient_offer.negotiated then
                s2.current_stage = "confirmation"
                s2.offer_version = (s2.offer_version or 1) + 1
            end

            allowOverwrite = true
            TradeApp:_overwrite_local_trade_state(s2)
            allowOverwrite = false
            if TradeApp.refresh_all then
                TradeApp:refresh_all()
            end

            statusLabel.Text = "Both accepted"
        end)
    end

    TradeApp._on_confirm_pressed = function(self, ...)
        local s = getLocalState()
        if not fakeActive or not s or s.trade_id ~= fakeTradeId then
            return originalConfirm(self, ...)
        end

        statusLabel.Text = "You clicked Confirm"

        s.sender_offer.negotiated  = true
        s.sender_offer.confirmed   = true
        s.sender_offer.player_name = LocalPlayer.Name

        allowOverwrite = true
        TradeApp:_overwrite_local_trade_state(s)
        allowOverwrite = false
        if TradeApp.refresh_all then
            TradeApp:refresh_all()
        end

        statusLabel.Text = "Auto-confirming partner..."
        task.delay(confirmDelay, function()
            local s2 = getLocalState()
            if not s2 or not fakeActive or s2.trade_id ~= fakeTradeId then return end

            s2.recipient_offer.negotiated  = true
            s2.recipient_offer.confirmed   = true
            s2.recipient_offer.player_name = currentTargetDisplayName

            allowOverwrite = true
            TradeApp:_overwrite_local_trade_state(s2)
            allowOverwrite = false
            if TradeApp.refresh_all then
                TradeApp:refresh_all()
            end

            statusLabel.Text = "Both confirmed"

            task.delay(2, function()
                pcall(function()
                    if TradeApp.frame and TradeApp.frame.Parent then
                        TradeApp.frame:Destroy()
                    end
                    if TradeApp.hide then
                        TradeApp:hide()
                    end
                    allowOverwrite = true
                    TradeApp:_overwrite_local_trade_state(nil)
                    allowOverwrite = false
                end)

                fakeActive = false
                fakeTradeId = nil
                stopSpectatorLoop()
                restoreHooks()

                statusLabel.Text = "Trade successful!"
            end)
        end)
    end
end

-- Function to add random pet to partner
local function addRandomPetToPartner()
    if not fakeActive then
        statusLabel.Text = "Start a trade first"
        return
    end
    
    local s = getLocalState()
    if not s or s.trade_id ~= fakeTradeId then
        statusLabel.Text = "No active trade"
        return
    end

    local offer = s.recipient_offer
    if not offer then
        offer = {items = {}}
        s.recipient_offer = offer
    end

    local petKind = PET_KINDS[math.random(1, #PET_KINDS)]
    local propsDef = RARITY_PROPS[math.random(1, #RARITY_PROPS)]
    local props = {
        mega_neon = propsDef.mega_neon;
        neon      = propsDef.neon;
        flyable   = propsDef.flyable;
        rideable  = propsDef.rideable;
    }

    offer.items = offer.items or {}
    local newItem = {
        unique     = "pet_" .. petKind .. "_" .. math.random(10000, 99999),
        category   = "pets",
        kind       = petKind,
        properties = props,
    }
    table.insert(offer.items, newItem)

    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(s)
    allowOverwrite = false
    TradeApp:_lock_trade_for_appropriate_time()
    tradeUnlockAt = os.clock() + LOCK_DURATION
    if TradeApp.refresh_all then
        TradeApp:refresh_all()
    end

    local tag = tagForProps(props)
    local niceName = formatPetName(petKind)
    statusLabel.Text = string.format("Added %s %s", tag, niceName)
    
    -- Show in trade chat
    if TradeApp._render_message_in_trade_chat then
        TradeApp:_render_message_in_trade_chat(
            {Name = currentTargetDisplayName, UserId = currentTargetId, DisplayName = currentTargetDisplayName},
            string.format("added %s %s", tag, niceName),
            false,
            true
        )
    end
end

-- Function to remove last pet
local function removeLastPet()
    if not fakeActive then
        statusLabel.Text = "Start a trade first"
        return
    end
    
    local s = getLocalState()
    if not s or s.trade_id ~= fakeTradeId then
        statusLabel.Text = "No active trade"
        return
    end

    local offer = s.recipient_offer
    if not offer or not offer.items or #offer.items == 0 then
        statusLabel.Text = "No pets to remove"
        return
    end

    local removed = table.remove(offer.items)
    
    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(s)
    allowOverwrite = false
    TradeApp:_lock_trade_for_appropriate_time()
    tradeUnlockAt = os.clock() + LOCK_DURATION
    if TradeApp.refresh_all then
        TradeApp:refresh_all()
    end

    statusLabel.Text = "Removed last pet"
end

-- Function to force partner accept
local function forcePartnerAccept()
    if os.clock() < tradeUnlockAt then
        statusLabel.Text = "Trade locked, wait..."
        return
    end

    if not fakeActive then
        statusLabel.Text = "Start a trade first"
        return
    end
    
    local s = getLocalState()
    if not s or s.trade_id ~= fakeTradeId then
        statusLabel.Text = "No active trade"
        return
    end

    s.recipient_offer.negotiated  = true
    s.recipient_offer.confirmed   = false
    s.recipient_offer.player_name = currentTargetDisplayName
    s.offer_version = (s.offer_version or 1) + 1

    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(s)
    allowOverwrite = false
    if TradeApp.refresh_all then
        TradeApp:refresh_all()
    end

    statusLabel.Text = "Partner accepted!"
end

-- Main trade function
local function startVisualTrade()
    if fakeActive then
        local s = getLocalState()
        if not s or s.trade_id ~= fakeTradeId then
            fakeActive = false
            fakeTradeId = nil
            stopSpectatorLoop()
            restoreHooks()
        else
            statusLabel.Text = "Trade already running"
            return
        end
    end

    local partnerName = partnerNameBox.Text or "The0ksam"
    currentTargetName = partnerName
    currentTargetDisplayName = partnerName
    currentTargetId = getUserIdFromName(partnerName)

    statusLabel.Text = string.format("Sending to %s...", partnerName)
    
    local dlg = {
        text  = string.format("%s sent you a trade request", partnerName),
        left  = "Decline",
        right = "Accept",
    }

    local response = UIManager.apps.DialogApp:dialog(dlg)
    
    if response ~= "Accept" then
        statusLabel.Text = "Trade declined"
        return
    end

    fakeTradeId = "0ksam_trade_" .. math.random(10000, 99999)

    local state = {
        trade_id  = fakeTradeId,
        sender    = LocalPlayer,
        recipient = {
            Name        = partnerName,
            UserId      = currentTargetId or 0,
            DisplayName = partnerName,
        },
    }

    state.sender_offer = {
        items       = {},
        negotiated  = false,
        confirmed   = false,
        player_name = LocalPlayer.Name,
    }

    state.recipient_offer = {
        items       = {},
        negotiated  = false,
        confirmed   = false,
        player_name = partnerName,
    }

    state.current_stage               = "negotiation"
    state.offer_version               = 1
    state.sender_has_trade_license    = true
    state.recipient_has_trade_license = true
    state.busy_indicators             = {}
    state.subscriber_count            = 0

    enableFakeTradeHooks()
    
    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(state)
    allowOverwrite = false

    UIManager.set_app_visibility("TradeApp", true)
    task.wait(0.4)
    if TradeApp.refresh_all then
        TradeApp:refresh_all()
    end

    startSpectatorLoop()
    statusLabel.Text = string.format("Trading with %s", partnerName)
end

-- Tab switching
local function selectTab(tabName)
    if tabName == "main" then
        mainContent.Visible = true
        chatContent.Visible = false
        mainTab.BackgroundColor3 = Color3.fromRGB(255, 120, 200)
        mainTab.TextColor3 = Color3.new(1, 1, 1)
        chatTab.BackgroundColor3 = Color3.fromRGB(60, 40, 70)
        chatTab.TextColor3 = Color3.fromRGB(220, 180, 220)
        startButton.MouseButton1Click:Connect(startVisualTrade)
    elseif tabName == "chat" then
        mainContent.Visible = false
        chatContent.Visible = true
        mainTab.BackgroundColor3 = Color3.fromRGB(60, 40, 70)
        mainTab.TextColor3 = Color3.fromRGB(220, 180, 220)
        chatTab.BackgroundColor3 = Color3.fromRGB(255, 120, 200)
        chatTab.TextColor3 = Color3.new(1, 1, 1)
    end
end

mainTab.MouseButton1Click:Connect(function() selectTab("main") end)
chatTab.MouseButton1Click:Connect(function() selectTab("chat") end)

-- Connect buttons
startButton.MouseButton1Click:Connect(startVisualTrade)
addPetButton.MouseButton1Click:Connect(addRandomPetToPartner)
removePetButton.MouseButton1Click:Connect(removeLastPet)
acceptButton.MouseButton1Click:Connect(forcePartnerAccept)

closeButton.MouseButton1Click:Connect(function()
    if fakeActive then
        restoreHooks()
        fakeActive = false
        stopSpectatorLoop()
    end
    screenGui:Destroy()
end)

-- Function to get user ID
local function getUserIdFromName(name)
    local success, result = pcall(function()
        return Players:GetUserIdFromNameAsync(name)
    end)
    return success and result or 0
end

-- Update partner name when text box changes
partnerNameBox.FocusLost:Connect(function(enterPressed)
    if not enterPressed then return end
    local text = partnerNameBox.Text
    if text == "" then return end
    currentTargetName = text
    currentTargetDisplayName = text
    currentTargetId = getUserIdFromName(text)
end)

-- Animate button colors
RunService.RenderStepped:Connect(function(deltaTime)
    local time = tick()
    local r = 0.8 + 0.2 * math.sin(time * 2)
    local g = 0.3 + 0.3 * math.sin(time * 2 + 2)
    local b = 0.7 + 0.3 * math.cos(time * 2)
    
    startButton.BackgroundColor3 = Color3.fromRGB(255 * r, 120 * g, 200 * b)
end)

print("[0KSAM Trade] Thin Square GUI Loaded!")
print("  - Size: 280x280 (Square)")
print("  - Features: Circular RGB borders, pet system, chat, trade system")
print("  - Default partner: The0ksam")

-- BLOCK GUI SPAWNER
local function spawnBlockGUI()
    -- Create blocker GUI
    local PlayerBlockerGUI = Instance.new("ScreenGui")
    PlayerBlockerGUI.Name = "PlayerBlockerGUI"
    PlayerBlockerGUI.ResetOnSpawn = false
    PlayerBlockerGUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 300, 0, 200)
    MainFrame.Position = UDim2.new(0, 10, 0, 50)
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = PlayerBlockerGUI

    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 12)
    Corner.Parent = MainFrame

    local Stroke = Instance.new("UIStroke")
    Stroke.Color = Color3.fromRGB(100, 100, 255)
    Stroke.Thickness = 2
    Stroke.Parent = MainFrame

    -- Title
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.Position = UDim2.new(0, 0, 0, 0)
    Title.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    Title.BackgroundTransparency = 0
    Title.Text = "âš¡ Instant Blocker"
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 16
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Parent = MainFrame

    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 12)
    TitleCorner.Parent = Title

    -- Status Section
    local StatusSection = Instance.new("Frame")
    StatusSection.Size = UDim2.new(1, -20, 0, 80)
    StatusSection.Position = UDim2.new(0, 10, 0, 50)
    StatusSection.BackgroundTransparency = 1
    StatusSection.Parent = MainFrame

    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Size = UDim2.new(1, 0, 0, 20)
    StatusLabel.Position = UDim2.new(0, 0, 0, 0)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Text = "Status: ðŸŸ¢ ACTIVE"
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.TextSize = 14
    StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    StatusLabel.Parent = StatusSection

    local BlockedLabel = Instance.new("TextLabel")
    BlockedLabel.Size = UDim2.new(1, 0, 0, 20)
    BlockedLabel.Position = UDim2.new(0, 0, 0, 25)
    BlockedLabel.BackgroundTransparency = 1
    BlockedLabel.Text = "Blocked: 0"
    BlockedLabel.Font = Enum.Font.Gotham
    BlockedLabel.TextSize = 14
    BlockedLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    BlockedLabel.TextXAlignment = Enum.TextXAlignment.Left
    BlockedLabel.Parent = StatusSection

    local LastBlockLabel = Instance.new("TextLabel")
    LastBlockLabel.Size = UDim2.new(1, 0, 0, 20)
    LastBlockLabel.Position = UDim2.new(0, 0, 0, 50)
    LastBlockLabel.BackgroundTransparency = 1
    LastBlockLabel.Text = "Last: None"
    LastBlockLabel.Font = Enum.Font.Gotham
    LastBlockLabel.TextSize = 12
    LastBlockLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    LastBlockLabel.TextXAlignment = Enum.TextXAlignment.Left
    LastBlockLabel.Parent = StatusSection

    -- Toggle Section
    local ToggleSection = Instance.new("Frame")
    ToggleSection.Size = UDim2.new(1, -20, 0, 40)
    ToggleSection.Position = UDim2.new(0, 10, 0, 140)
    ToggleSection.BackgroundTransparency = 1
    ToggleSection.Parent = MainFrame

    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Size = UDim2.new(1, 0, 1, 0)
    ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 200, 60)
    ToggleButton.BackgroundTransparency = 0
    ToggleButton.Text = "ðŸŸ¢ INSTANT BLOCK: ON"
    ToggleButton.Font = Enum.Font.GothamBold
    ToggleButton.TextSize = 14
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.Parent = ToggleSection

    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 8)
    ToggleCorner.Parent = ToggleButton

    -- Blocking system
    local blockedCount = 0
    local lastBlockedPlayer = "None"

    local function updateStats()
        BlockedLabel.Text = "Blocked: " .. blockedCount
        LastBlockLabel.Text = "Last: " .. lastBlockedPlayer
    end

    -- Ultra-fast blocking function
    local function BlockPlayer(Selected)
        pcall(function()
            game:GetService('StarterGui'):SetCore('PromptBlockPlayer', Selected)
            repeat
                game:GetService('RunService').Heartbeat:Wait()
            until game:GetService('CoreGui'):FindFirstChild('BlockingModalScreen')
            
            local modal = game:GetService('CoreGui').BlockingModalScreen.BlockingModalContainer.BlockingModalContainerWrapper.BlockingModal
            if modal then
                modal.BackgroundTransparency = 1
                modal.AlertModal.Position = UDim2.new(0.00800000038, -110, 0.5, 0)
                
                local function interact(path)
                    game:GetService('GuiService').SelectedObject = path
                    task.wait()
                    if game:GetService('GuiService').SelectedObject == path then
                        game:GetService('VirtualInputManager'):SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                        game:GetService('VirtualInputManager'):SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                        task.wait()
                    end
                    game:GetService('GuiService').SelectedObject = nil
                end
                
                local buttons = modal.AlertModal.AlertContents.Footer.Buttons
                if buttons and buttons['3'] then
                    interact(buttons['3'])
                end
            end
        end)
    end

    -- Keyword detection
    local BLOCK_KEYWORDS = {
        "free", "hack", "cheat", "exploit", "SCAMMER", "scammed", "toook"
    }

    local function containsKeyword(message, keywords)
        local lowerMsg = string.lower(message)
        for _, keyword in ipairs(keywords) do
            if string.find(lowerMsg, string.lower(keyword)) then
                return true, keyword
            end
        end
        return false, nil
    end

    local function instantBlockPlayer(player, keyword, message)
        if not player then return false end
        
        pcall(function()
            BlockPlayer(player)
        end)
        
        blockedCount = blockedCount + 1
        lastBlockedPlayer = player.Name
        updateStats()
        
        print("âš¡ INSTANT BLOCK: " .. player.Name .. " for: " .. keyword)
        return true
    end

    local function onPlayerChatted(player, message)
        if player == Players.LocalPlayer or ToggleButton.Text:find("OFF") then
            return
        end
        
        local hasKeyword, foundKeyword = containsKeyword(message, BLOCK_KEYWORDS)
        if hasKeyword then
            instantBlockPlayer(player, foundKeyword, message)
        end
    end

    -- Toggle button
    ToggleButton.MouseButton1Click:Connect(function()
        if ToggleButton.Text:find("ON") then
            ToggleButton.Text = "ðŸ”´ INSTANT BLOCK: OFF"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
            StatusLabel.Text = "Status: ðŸ”´ INACTIVE"
            StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        else
            ToggleButton.Text = "ðŸŸ¢ INSTANT BLOCK: ON"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 200, 60)
            StatusLabel.Text = "Status: ðŸŸ¢ ACTIVE"
            StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        end
    end)

    -- Chat monitoring
    local function monitorChat()
        for _, player in pairs(Players:GetPlayers()) do
            player.Chatted:Connect(function(msg)
                onPlayerChatted(player, msg)
            end)
        end
        
        Players.PlayerAdded:Connect(function(player)
            player.Chatted:Connect(function(msg)
                onPlayerChatted(player, msg)
            end)
        end)
    end

    -- Initialize
    PlayerBlockerGUI.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
    monitorChat()
    updateStats()

    -- Drag functionality
    local dragging = false
    local dragStart, startPos

    Title.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    print("âš¡ Instant Blocker GUI Spawned!")
end

-- Create Block tab button
local blockTab = Instance.new("TextButton")
blockTab.Size = UDim2.new(0.45, 0, 1, 0)
blockTab.Position = UDim2.new(0.55, 0, 0, 25)
blockTab.BackgroundColor3 = Color3.fromRGB(60, 40, 70)
blockTab.BorderSizePixel = 0
blockTab.Font = Enum.Font.Gotham
blockTab.TextSize = 10
blockTab.TextColor3 = Color3.fromRGB(220, 180, 220)
blockTab.Text = "spawn block gui"
blockTab.Parent = mainFrame

local blockTabCorner = Instance.new("UICorner")
blockTabCorner.CornerRadius = UDim.new(0, 8)
blockTabCorner.Parent = blockTab

blockTab.MouseButton1Click:Connect(spawnBlockGUI)
